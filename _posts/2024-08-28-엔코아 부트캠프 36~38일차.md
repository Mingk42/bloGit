## 2번째 팀 프로젝트

2번 째 팀프로젝트가 시작되었다. 매일 작성해야 했는데 팀 프로젝트에 집중하다가 매일 기록하는 것을 놓쳐버렸다..

그래도 늦게나마 기록해본다.

#### kafka로 chat 프로그램 만들기

이번 프로젝트는 kafka를 이용하여 채팅프로그램을 만드는 것이었다. 전에 독학하면서 문득 채팅프로그램은 어떻게 만드는지 궁금해서 구글링을 통해 만들어본 적은 있는데 kafka로 만든다고 생각하니 뭔가 잘 와닿지 않았다. 전에 만든 채팅프로그램은 socket을 이용해 만들었는데 kafka가 기본적으로 보낼 수 있고 받을 수 있어서 채팅프로그램으로 동작할 수 있겠지만, socket으로 만드는 것보다 쉽지 않을 것 같다는 생각이 들었다. Kafka의 경우 보내기만 하는 producer와 받기만 하는 consumer로 이루어져 있기 때문이다. 그것은 멀티스레드를 이용해 만들 수 있다는 것을 내가 졸업식 갔던 날 해봤다고 한다. 

먼저 요구사항을 작성했다. 전에 만들어본 경험 덕분에 부가적인 기능으로 뭔가 필요할지 생각하기 수월했다.

일단 만들어야 하는 프로그램의 요구사항은 다음과 같다.

- [ ] 업무 대화 기능
- [ ] 업무 대화 감사 기능 ( 검색, 대화 주제 통계 ) - zeppelin
- [ ] 영화 챗봇기능 ( @bot 파묘 감독은 누구야? )
- [ ] 시스템 챗봇기능 ( airflow JOB ... 성공 실패 )
- [ ] 일정 챗봇기능 ( 애자일 칸반 미팅 시간 입니다 )

추가적으로 중간에 대화명을 변경할 수 있으면 좋겠다는 생각이 들었고, 입장시/퇴장시 알림이 나타났으면 좋겠다는 생각을 했다. 그리고 단순하게 콘솔창이 아닌 깔끔한 UI에 대한 이야기도 나왔다.

이 정도의 요구사항을 기준으로 개발에 착수했다.

1일차에는 채팅기능을 구현하고 UI를 입히는 것으로 하루를 보낼 예정이었다. 그런데 UI에 가로막혀 하루를 모두 날려버렸다. UI로 사용하려고 했던 것은 streamlit이었는데 하루종일 연구해봐도 채팅기능과 streamlit을 연결할 수 없었다. 나중에 알게 된 바로는 streamlit이 bot과의 대화만을 지원하고 다중 이용자가 대화하는 것은 지원하지 않는다고 하는데, 사실 여전히 연구하면 될 것 같은 미련이 조금 남아있다. 그렇게 1일차는 아무것도 만들지 못하고 지나가버렸다. 나머지 기능도 모두 대화기능이 구현되어야 어떻게 할지 맞춰서 만들 수 있었기 때문이다.

2일차가 되었을 때는 아무것도 없이 1일을 소모해버렸기 때문에 UI는 포기하고 기능에 집중하기로 했다. 요구한 기능을 모두 구현하기에도 시간이 촉박할 수 있었기 때문이다. 그리고 각자 하나의 기능씩을 구현하였는데, 나는 airflow pipeline을 구축하는 것을 맡았다. 

![image](https://github.com/user-attachments/assets/7cf5f352-3482-4be0-b672-302d67ec389f)

해당 pipeline의 목적은 채팅 log를 읽어서 분석할 수 있는 parquet파일로 변환하는 것이다. 

제일 먼저 해당일자의 채팅 log파일이 있는지 확인하는 branchOperator를 위치시켰다. log파일이 없다면 이어지는 작업을 할 필요가 없기 때문에 컴퓨팅 자원을 절약하는 차원에서 필요하다고 생각했다. 그래서 log파일이 있다면 다음 작업으로 이어지고 없다면 마지막 task로 넘어간다.

다음 작업은 이미 해당일자에 만들어진 parquet파일이 있는지 확인하는 것이다. 그래서 이미 생성된 파일이 있다면 해당 파일을 삭제함(rm.dir)으로써 멱등성을 유지하려고 하였다. 

그 다음 작업은 가장 중요한 log파일을 읽어서 parquet파일로 전환하는 작업이다. 이 task를 구현하는데 가장 많은 시간이 들기도 했다. 몇 가지 문제가 있었는데 큰 문제 몇 개만 기억난다.

먼저 log파일에서 {}로 감싸진 부분만 가져오고 싶은데 어떻게 할지 고민이었다. 그래서 구글링해본 결과 정규표현식을 이용하면 되겠다는 답을 얻었다. 

성공적으로 값을 가져왔는데 또 문제가 생겼다. 해당 부분을 dictionary로 변환해야 하는데, 결과값이 str이라서 dict()함수를 이용해서 dictionary로 변환하려고 하면 오류가 나타났다. 해당 문제를 해결하는 방법으로 eval()함수가 있었다. 다른 프로그래밍 언어에도 있다는 해당 함수는 문자열을 읽어서 프로그래밍 언어의 표현으로 변환해주는 함수이다.

해당 데이터를 통해 DataFrame을 만드는데 성공했고 이제 parquet으로 저장만 하면 되겠다고 생각했는데, parquet으로 저장하는 과정에서 또 오류가 발생했다. Kafka 채팅프로그램에서 한글을 적었다가 지우면 공백이 하나씩 남는 현상이 있었는데 해당 공백이 인코딩되지 않는 문자라서 오류를 발생시키는 것이었다. 여기서 엄청 많은 시간을 소비했는데 정규표현식으로 문자, 공백, 지정된 특수문자 외에 모두 없애는 것으로 해결하였다. 일반적인 텍스트는 문제 없겠지만 수동으로 허용되는 특수문자를 지정해주어야 한다는 것이 아쉬운 부분이다. 하지만 시간이 없어서 이것이 최선의 선택이었다. 추후 다른 조의 발표에서 알게 되었는데, json.dumps()함수의 옵션에서 이를 제어할 수 있다고 한다. 진작 알았으면 좋았을 것 같다는 아쉬움이 남았다.

그리고 마지막으로 모든 task가 정상실행되었는지 채팅 프로그램으로 알림을 보내는 task를 추가했다. 모든 task가 정상 실행되었을 경우(또는 log파일이 없어서 모든 task를 skip한 경우) 성공 message를 보내고, 하나의 task라도 실패하면 실패 message를 보내는 것이다. 

###### 성공시

###### 실패시 


2일차에서 긍정적이었던 부분은 모든 팀원이 각자의 역할을 잘 했고 그 결과 1일차가 성과없이 끝났지만 2일차에 예정된 진도를 맞췄다는 것이다.

3일차는 기능을 점검하고 소소하게 수정할 부분을 수정하는 시간을 보냈다. 특별한 일은 없었던 것 같다.

### 정리

이번 프로젝트를 하면서 느낀 점이 있다면, 빠르게 포기하는 것도 중요하다는 것이다. 일정이 3일로 짧은 편이었는데 UI에 매몰되어 1일이라는 시간을 소모한 것이 치명적이었고, 그로 인해 2일차에 여유롭게 진행할 수 있었던 일들을 다급하게 처리해야 했다.

한편으로 채팅 기능을 구현하면서 Kafka의 여러 부분을 자연스럽게 학습해야 했어서 유익한 시간이었다는 생각이 든다.

마지막으로 첫 번째 팀프로젝트보다 의사소통이 잘 되는 팀이었는데 그로 인해 팀프로젝트가 너무 재미있었고 진행 사항을 알기 쉬워서 좋았다.
