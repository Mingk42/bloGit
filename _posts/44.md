## FastAPI 부하테스트 이어서

#### stress test on AWS EC2

오늘도 어제에 이어서 부하테스트를 진행했다. 다만 어제와 다른 것은 AWS EC2에서 부하테스트를 진행했다는 것이다. 

<img src="https://github.com/user-attachments/assets/36c89f2c-5599-4a13-b180-68a9627e31a8" width="50%" />

기존에 로컬에서 부하테스트를 진행했을 때는 여러가지 프로그램이 함께 실행되고 있었기 때문에 순수 성능을 보이지 못했을 가능성이 있는데, 오늘의 테스트는 각 부분을 전용 EC2로 구성하였기 때문에 방해요인이 없이 순수한 성능을 확인해볼 수 있었다. 

이를 위해 먼저 각 EC2를 세팅해주었다.

#### EC2_nginder

먼저 ngrinder를 설치해보았다. 사실 ngrinder는 특별하게 세팅을 할 건 없었다. controller를 다운로드 받았고, agent는 로컬에 있던 파일을 scp로 옮겨주었다. 그리고 jdk-11을 설치해주었다. 

준비 완료!

#### ml server

ml server도 어렵지 않았다. 기존에 로컬에서 만든 이미지를 docker hub에 올려두었는데 받아와서 실행해주면 되는 것이었다. 다만 로컬에서 할 때와는 다르게 포트를 지정해주어야 한다. 서로 다른 인스턴스(~다른 PC)에서 동작하고 있으므로 `--link`옵션을 사용할 수 없기 때문이다.

#### EC2_Load Balance

Load balance를 위해 docker image로 nginx를 build하였다. nginx에서 proxy를 적용하기 위해 default.conf파일을 포함하여 build하였는데 이 부분이 중요한 부분이었던 것 같다!

###### default.conf
```bash
upstream ml_servers {
        server <ml-1 server private ip>:8080;
        server <ml-2 server private ip>:8080;
        server <ml-3 server private ip>:8080;
}

server {
        listen 80;

        location /
        {
                proxy_pass http://ml_servers;
        }
}
```

위에서 언급했듯이 `--link`옵션을 사용할 수 없으니 아이피를 명시해주어야 한다. 이 때, public ip가 아니라 private ip를 적어주어야 한다는 것이다!

ml server를 run한 상태에서 브라우저로 접속할 때는 public ip로 접속이 가능했다. 그래서 처음에는 당연히 public ip를 명시하고 build하였는데 접속이 정상적으로 되지 않았다. 그리고 문제 원인이 private ip라는 것을 알게 되었을 때 뭔가 의문스러웠다. 그리고 그 이유를 나중에 강사님이 설명해 주셨다.

어쨋든 build하고 실행해보면... Load balance 구축 완료!

#### 부하 테스트 실행

이제 부하테스트를 진행해 볼 시간!

테스트는 지금까지와 같이 1000명의 가상 유저가 요청을 보내는 상황으로 진행하였다.

![image](https://github.com/user-attachments/assets/ea388325-4eff-41f1-8b66-fea7610a31b8)

LB 서버가 1개 일 때에 비해 2개일 때 확연한 성능 개선을 보였다. 반면 3개일 때는 2개일 때에 비해 눈에 띄는 성능 개선이 없었는데, 이에 대해 1000명의 가상유저에 대해서는 LB 서버가 2개일 때 이미 안정적인 성능이 나오고 있었으므로 더 많은 가상유저로 테스트를 진행해보면 차이가 날 것이라고 강사님이 이야기하셨다.

그래서 2차 테스트!
![image](https://github.com/user-attachments/assets/cae1b1b0-7276-484d-8821-b8324e61cf89)

이번에는 가상유저의 수를 2000명으로 늘렸다.

그리고 결과는 LB서버가 1개 일 때 못 버티고 서버가 꺼진 반면 2개에서 성능이 올라간 것이 눈에 띈다. 최대 TPS기준 1.8배 정도 상승한 것으로 보인다.
그리고 서버가 3개일 때도 2개일 때에 비해 성능이 향상되는 것이 육안으로 확인가능했다. 최대 TPS기준으로는 1.46배 정도 향상된 것으로 보였다.

#### 방화벽

수업이 끝날 즈음 강사님께서 내부IP로 LB을 설정해야 하는 이유를 이야기 해주셨다. 그건 바로 방화벽 때문이었다. AWS에 나는 자유롭게 접속할 수 있어서 모든 요청에 대해 허용된다고 착각했지만 사실 방화벽으로 닫혀있어서 나도 접속 불가능한 상태가 잠깐 있었던 것이 기억났다. 따라서 public IP를 이용하여 접

### 정리
