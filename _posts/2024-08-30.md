## 대제목

오늘은 간단한 머신러닝 프로그램을 만들어 보았다.

![image](https://github.com/user-attachments/assets/b2966e38-55dc-4e07-ba71-ee6accc98640)
위 그림과 같이 간단한 머신러닝을 FastAPI에 적용하여, 무게와 길이를 보내면 어떤 물고기인지 반환하는 API를 만드는 것이 최종 목표이다.

#### FastAPI로 기본 뼈대 만들기

먼저 FastAPI로 요청을 보내면 응답을 받을 수 있는 기본 뼈대를 구축하였다.

FastAPI의 사용법은 전에도 학습한 적이 있지만 [docs](https://fastapi.tiangolo.com/ko/)를 보고 따라가면 쉽게 만들 수 있다.

```bash
$ pdm init
$ pdm add fastapi
$ pdm add "uvicorn[standard]"
$ vi src/pkg/main.py
```
###### main.py
```python
from typing import Union

from fastapi import FastAPI

app = FastAPI()


@app.get("/")
def read_root():
    return {"Hello": "World"}


@app.get("/items/{item_id}")
def read_item(item_id: int, q: Union[str, None] = None):
    return {"item_id": item_id, "q": q}

@app.get("/fish")
def fish(length:float, weight:float):
    """
    어종 판별기

    Args:
     - length(int): 물고기 길이(cm)
     - weight(int): 물고기 무게(g)

    Return
     - dict, 물고기의 종류를 담은 딕셔너리
    """

    if length>=30:
        pred="도미"
    else:
        pred="빙어"


    return {
            "prediction":pred,
            "length":length,
            "weight":weight
            }
```

기본 예제에 우리가 최종 목표로 하는 fish함수를 추가해주었다. 아직은 학습된 모델이 없기 때문에 길이가 30cm 이상이면 도미 그 외에는 빙어로 예측값을 반환해주었다.

#### docker에 FastAPI 띄우기

그 다음에는 만들어진 FastAPI를 docker container로 띄워보았다. 이는 최종목표인 fly.io에 Dockerfile로 배포를 할 것이기 떄문에 작성된 Dockerfile이 잘 작성되었는지 확인하는 역할을 할 수 있고 FastAPI가 잘 동작하는지도 확인해 볼 수 있다. docker에서 잘 동작한다면 fly.io에서도 잘 동작할 것이라고 가정할 수 있다는 것이다.

아래와 같이 Dockerfile을 작성했다.
###### Dockerfile
```
FROM python:3.9     # Base Image, 어떤 image를 기반으로 docker image를 생성할 것인지 지정해준다.

WORKDIR /code       # working directory, 말 그대로 어떤 디렉토리에서 작업을 수행하는지 지정해준다.

COPY . /code        # Dockerfile이 위치한 디렉토리의 모든 파일과 디렉토리를 docker image의 /code로 복사한다. 

# docker container가 생성될 때 실행되는 명령. 여러 번 실행 가능하다.
RUN pip install --no-cache-dir --upgrade -r /code/requirements.txt

# RUN과 같이 container가 생성될 때 실행되는 명령이지만, 한 번만 실행가능하다. 서버 구동에 쓰인다.
CMD ["uvicorn", "src.fishmlserv.main:app", "--host", "0.0.0.0", "--port", "8080"]
```


```bash
$ sudo docker build -t fishmlserv:0.4.0 .
# fishmlserv:0.4.0  docker tag
# . 현재 폴더에 있는 Dockerfile을 읽어옴
```


### 정리
