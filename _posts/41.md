## MANIFEST.io

ì˜¤ëŠ˜ì€ ê¸ˆìš”ì¼ì— ë§Œë“¤ì—ˆë˜ FastAPIë¥¼ ì¡°ê¸ˆ ë” ì •êµí™”í•˜ëŠ” ì‘ì—…ì„ í–ˆë‹¤.

ìˆœì„œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

1. Dockerfileì—ì„œ pip installì„ requirements.txtê°€ ì•„ë‹ˆë¼ githubì—ì„œ ê°€ì ¸ì˜¤ë„ë¡ ìˆ˜ì •
2. model.pkl íŒŒì¼ì´ pip installí–ˆì„ ë•Œ ê°™ì´ í¬í•¨ë˜ë„ë¡ ìˆ˜ì •
3. model.pkl íŒŒì¼ì´ ì„¤ì¹˜ëœ ìœ„ì¹˜ë¥¼ ì°¾ì•„ì„œ FastAPIì—ì„œ ì´ìš©í•˜ë„ë¡ ìˆ˜ì •

#### MANIFEST.io

Dockerfileì—ì„œ pip installì„ githubë¡œ ìˆ˜ì •í•˜ëŠ” ê²ƒì€ ì•„ì£¼ ê°„ë‹¨í•œ ì‘ì—…ì´ì—ˆë‹¤.
```
# RUN pip install --no-cache-dir --upgrade -r /code/requirements.txt
RUN pip install --no-cache-dir git+<github url>@<branch name>
```

ê·¸ ë‹¤ìŒì€ pip install í–ˆì„ ë•Œ model.pkl íŒŒì¼ì´ ê°™ì´ í¬í•¨ë˜ë„ë¡ í•˜ëŠ” ê²ƒì´ì—ˆë‹¤.

ë¨¼ì € pklíŒŒì¼ì´ ì–´ë””ì— ì„¤ì¹˜ë˜ëŠ”ì§€ ìœ„ì¹˜ë¥¼ ì•Œ ìˆ˜ ìˆë„ë¡ ì„ì˜ì˜ íŒŒì¼ì„ í•˜ë‚˜ ë§Œë“¤ê³  í•´ë‹¹ íŒŒì¼ì´ ìœ„ì¹˜í•œ ê²½ë¡œë¥¼ ë°˜í™˜í•˜ë„ë¡ í•¨ìˆ˜ë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.
```python
def get_model_path():
    import os

    abspath = os.path.dirname(os.path.abspath(__file__))

    return os.path.join(abspath, "model.pkl")
```

ê·¸ë¦¬ê³  gitì— pushí•´ì£¼ê³  dockerë¥¼ buildí•´ë³¸ë‹¤.

```bash
$ git add .
$ git commit -m "commit msg"
$ git push

$ sudo docker build --no-cache -t fishmlserv:v0.7.0 .
$ sudo docker run -d -p <port>:8080 --name <container name> fishmlserv:v0.7.0
$ sudo docker exec -it <container id> bash

#################### container bash #############################
$ python
>>> from fishmlserv.model.<python file name> import get_model_path
>>> get_model_path()
/usr/local/lib/python3.9/site-packages/fishmlserv/model/model.pkl

>>> exit()

$ cd /usr/local/lib/python3.9/site-packages/fishmlserv/model/
$ ls
__init__.py  __pycache__  manager.py 
```
docker container ìƒì—ì„œ pkl íŒŒì¼ì´ ìœ„ì¹˜í•˜ëŠ” ê²½ë¡œë¥¼ ì¶œë ¥í•˜ê³ , í•´ë‹¹ ê²½ë¡œë¡œ ì´ë™í•´ë³´ë©´ pkl íŒŒì¼ì´ ì—†ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. ì´ëŠ” pip installì„ í•  ë•Œ pythoníŒŒì¼ë§Œì„ ê°€ì ¸ì˜¤ê³  ë‹¤ë¥¸ í˜•ì‹ì˜ íŒŒì¼ì€ ê°€ì ¸ì˜¤ì§€ ì•Šê¸° ë•Œë¬¸ì´ë‹¤. pkl íŒŒì¼ê³¼ ê°™ì´ python íŒŒì¼ì´ ì•„ë‹Œ ë‹¤ë¥¸ íŒŒì¼ì„ í¬í•¨ì‹œí‚¤ê³  ì‹¶ë‹¤ë©´, `MANIFEST.in`íŒŒì¼ì„ ìƒì„±í•´ì£¼ë©´ ëœë‹¤. 

###### MANIFEST.in
```bash
recursive-include src *.pkl
```

ê·¸ë¦¬ê³  ë‚˜ì„œ ë‹¤ì‹œ ì¼ë ¨ì˜ ì‘ì—…ì„ ë°˜ë³µí•œë‹¤. ê·¸ë¦¬ê³  ë‚˜ì„œ í™•ì¸í•´ë³´ë©´...
```python
$ cd /usr/local/lib/python3.9/site-packages/fishmlserv/model/
$ ls
__init__.py  __pycache__  manager.py  model.pkl
```
pkl íŒŒì¼ì´ ê°™ì´ ì„¤ì¹˜ë˜ì—ˆë‹¤!

ì´ì œ FastAPIì—ì„œ pkl íŒŒì¼ì„ ì´ìš©í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤. ğŸ‘

###### main.py
```python
@app.get("/fish")
def fish(length:float, weight:float):
    """
    ì–´ì¢… íŒë³„ê¸°

    Args:
     - length(int): ë¬¼ê³ ê¸° ê¸¸ì´(cm)
     - weight(int): ë¬¼ê³ ê¸° ë¬´ê²Œ(g)

    Return
     - dict, ë¬¼ê³ ê¸°ì˜ ì¢…ë¥˜ë¥¼ ë‹´ì€ ë”•ì…”ë„ˆë¦¬
    """
    
    from fishmlserv.model.manager import get_model_path

#    with open("./model/model.pkl", "rb") as f:
    with open(get_model_path(), "rb") as f:
        fish_model=pickle.load(f)
        
    pred=fish_model.predict([[length, weight]])[0]

    CLASSES={
                0:"ë¹™ì–´",
                1:"ë†ì–´"
            }

    return {
            "prediction":CLASSES[pred],
            # "prediction":get_model_path(),
            "length":length,
            "weight":weight
            }
```

#### ëª¨ë¸ í‰ê°€í•˜ê¸°

í‰ê°€ìš© ë°ì´í„°ë¥¼ ì£¼ì…¨ëŠ”ë°, í•´ë‹¹ íŒŒì¼ì˜ ê°¯ìˆ˜ê°€ 10,000,000ê°œë¼ì„œ ë„ì €íˆ ëŒì•„ê°€ì§€ê°€ ì•ŠìŠµë‹ˆë‹¤.



ëŒì•„ê°€ë©´ ë‚´ìš© ì¶”ê°€í•˜ê² ìŠµë‹ˆë‹¤.


### ì •ë¦¬

ì˜¤ëŠ˜ì€ íŒŒì´ì¬ì„ íŒ¨í‚¤ì§•í•  ë•Œ .py í™•ì¥ìê°€ ì•„ë‹Œ íŒŒì¼ì„ ì¶”ê°€í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì•˜ë‹¤.

ì ì  ë¬´ì–¸ê°€ë¥¼ ì œê³µí•˜ëŠ” ì‚¬ëŒì´ ë˜ê³  ìˆëŠ” ë“¯í•œ ê¸°ë¶„ì´ë‹¤. ë§ì€ ê²ƒì„ ì•Œê²Œ ë˜ì–´ ì¬ë¯¸ìˆë‹¤.
